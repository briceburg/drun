#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset

usage() {
  echo >&2 "Usage: drun [-x] [-e env-vars-to-forward] <image> [command]"
  exit 1
}

XTRACE=""
while getopts ':e:x' OPT; do
  case $OPT in
    e)
      ENVREGEX="$OPTARG";;
    x)
      XTRACE="y";;
    \?)
      echo >&2 "Unknown option -$OPTARG"
      usage;;
    :)
      echo >&2 "Missing argument for option -$OPTARG"
      usage;;
  esac
done
shift $((OPTIND-1))

IMAGE=$1
[ -z "$IMAGE" ] && usage
shift

ENV_FILE_OPT=""
if [ -n "${ENVREGEX:-}" ]; then
  ENV_FILE=$(echo ".local-env-$$")
  env | grep '=' | awk -F '=' '{if($1 ~ /'"$ENVREGEX"'/) print}' > $ENV_FILE
  trap "rm $ENV_FILE" EXIT
  ENV_FILE_OPT="--env-file=$ENV_FILE"
fi

RM_OPT=${RM_OPT=--rm}

TTY_OPT=""
[[ -t 1 ]] && TTY_OPT="-it"

CURRENT_DIR=$(pwd)
CONTAINER_HOME=$CURRENT_DIR

[ -n "${XTRACE:-}" ] && set -o xtrace
docker run $RM_OPT $TTY_OPT \
  -v $CURRENT_DIR:$CONTAINER_HOME -e HOME=$CONTAINER_HOME -w $CONTAINER_HOME \
  -v ~/.ssh:$CONTAINER_HOME/.ssh:ro \
  -v ~/.ssh/known_hosts:/root/.ssh/known_hosts:ro \
  --net=host \
  $ENV_FILE_OPT ${EXTRA_OPTS:-} \
  $IMAGE "$@"
